# underrail　ファイル仕様について

## 基本
[MS-NRBF](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrbf/75b9fe09-be15-475f-85b8-ae7b7558cfe5) によってシリアライズ化されたオブジェクトがdataフォルダに収められている。
これをデシリアライズし、オブジェクトに含まれる値を直接書き換えることで文章の置き換えが可能になる。

また、.itemファイルと.kファイルにはさらにgzip圧縮がかかっている。
.udlgには圧縮がない。

### underrail特有のヘッダ
全てのデータファイルには(gzip圧縮されたものも含め)24バイトのヘッダが登場する。内部的にはバージョン識別子などらしい。
このヘッダを汚染するとゲームに正しく読み込まれないため、元の値を保存しなければならない。
gzip圧縮されるファイルタイプの場合、ヘッダを取り除いた後に先頭2バイトを見るときちんとgzipのMagic Numberが確認できる（そのため、7zなどの高機能なソフトでは壊れたアーカイブとみなされず、普通に展開できるようだ）

### 文字列の形式
ヘッダ1-5バイト(長さを表す) + UTF-8エンコードされた文字列。
パターンマッチで探すことはできるので、従来の方法のように「文字列データの開始位置と終了位置」さえ把握していれば、書き換えソフトを作ることは可能。
元ファイルへのアップデートがあるとオフセットがずれてダメになるので、本プロジェクトでは将来を鑑みてもう少し構造的にシリアライズフォーマットを読み解く形を採用した。

### 翻訳対象ファイル
.udlg - gzip圧縮されていない。会話文など。
.k    - gzip圧縮されている。ゲーム内のツールチップなど
.item - gzip圧縮されている。アイテムの説明文など。性能もここに依存している可能性がある。

## フォント
ビットマップフォントであるため、日本語を追加するためには日本語のビットマップフォントを用意する必要がある。
data/fonts/に置かれている。xnbであるため編集には展開が必要。
ファイル名は(アルファベット1文字の識別子)(フォントサイズ)(suffix)で、
識別子がフォントの種類を、フォントサイズはそのままフォントサイズを、suffixはregular(なし)/bold(b)/italic(i)/bold+italic(bi)を表す。

### フォントと解像度について
[先駆者](https://drive.google.com/file/d/1R2pzCcpT5F696FQou-39KuJiTzyayLKY/view) は、ゲーム中で日本語の表示に使われそうなフォントだけを置き換えたため、
日本語の表示に関係のない一部のフォントに関しては弄っていない。
c16系+c18系+c20系+それ以上のサイズは日本語が抜けている。

実はこれは落とし穴で、underrailは画面の解像度を変えると参照されるビットマップフォントも変わる。

たとえばキャラメイク・フィート選択時の説明文は、デフォルト解像度だとc19であり、表示に問題はないが、
解像度を1920*1080にするとc20が参照されるようになって日本語を表示できなくなる。
「全部置き換える」がおそらく安全策。